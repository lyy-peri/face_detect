import cv2
import os
import sys
import random

out_dir = './Face_date1/other'
if not os.path.exists(out_dir):
    os.makedirs(out_dir)

# æ”¹å˜äº®åº¦ä¸Žå¯¹æ¯”åº¦
def relight(img, alpha=1, bias=0):
    w = img.shape[1]
    h = img.shape[0]
    #image = []
    for i in range(0,w):
        for j in range(0,h):
            for c in range(3):
                tmp = int(img[j,i,c]*alpha + bias)
                if tmp > 255:
                    tmp = 255
                elif tmp < 0:
                    tmp = 0
                img[j,i,c] = tmp
    return img

# èŽ·å–åˆ†ç±»å™¨
haar = cv2.CascadeClassifier("C:\\Users\\peri\\Desktop\\opencv\\sources\\data\\haarcascades\\haarcascade_frontalface_default.xml")

# æ‰“å¼€æ‘„åƒå¤´ å‚æ•°ä¸ºè¾“å…¥æµï¼Œå¯ä»¥ä¸ºæ‘„åƒå¤´æˆ–è§†é¢‘æ–‡ä»¶
camera = cv2.VideoCapture(0)

n = 1
while 1:
    if (n <= 100):
        print('It`s processing %s image.' % n)
        # è¯»å¸§
        success, img = camera.read()
        #è½¬ä¸ºç°åº¦å›¾åƒ
        gray_img = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
        #ä½¿ç”¨ haar.detectMultiScale æ–¹æ³•åœ¨ç°åº¦å›¾åƒ gray_img ä¸­è¿›è¡Œäººè„¸æ£€æµ‹ï¼Œå¹¶è¿”å›žæ£€æµ‹åˆ°çš„äººè„¸ä½ç½®ä¿¡æ¯
        #gray_imgï¼šè¡¨ç¤ºè¾“å…¥çš„ç°åº¦å›¾åƒï¼Œé€šå¸¸æ˜¯å°†å½©è‰²å›¾åƒè½¬æ¢ä¸ºç°åº¦å›¾åƒåŽè¿›è¡Œäººè„¸æ£€æµ‹ï¼Œå› ä¸ºäººè„¸æ£€æµ‹é€šå¸¸ä½¿ç”¨ç°åº¦å›¾åƒæ¥æé«˜æ£€æµ‹çš„å‡†ç¡®çŽ‡å’Œæ€§èƒ½
        #1.3ï¼šè¡¨ç¤ºæ¯æ¬¡å›¾åƒå°ºåº¦å‡å°çš„æ¯”ä¾‹ã€‚åœ¨æ¯æ¬¡æ£€æµ‹è¿‡ç¨‹ä¸­ï¼Œå›¾åƒä¼šé€æ¸ç¼©å°ä»¥å¯»æ‰¾ä¸åŒå°ºå¯¸çš„äººè„¸ã€‚è¿™ä¸ªå‚æ•°å¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œè°ƒæ•´ï¼Œé€šå¸¸è®¾ç½®åœ¨ 1.1 åˆ° 1.5 ä¹‹é—´ã€‚
        #5ï¼šè¡¨ç¤ºå‚æ•°minNeighborsï¼ŒæŒ‡å®šåœ¨ä¸€ä¸ªç›®æ ‡åŒºåŸŸä¸­æ£€æµ‹åˆ°å¤šå°‘ä¸ªå¯¹è±¡æ‰è®¤ä¸ºæ˜¯çœŸæ­£çš„ç›®æ ‡ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè¿™ä¸ªå€¼è¶Šå¤§ï¼Œå‡†ç¡®çŽ‡è¶Šé«˜ï¼Œä½†å¯èƒ½ä¼šæ¼æŽ‰ä¸€äº›ç›®æ ‡ï¼›è¿™ä¸ªå€¼è¶Šå°ï¼Œæ£€æµ‹åˆ°çš„ç›®æ ‡è¶Šå¤šï¼Œä½†ä¹Ÿå¯èƒ½ä¼šåŒ…æ‹¬ä¸€äº›é”™è¯¯çš„ç›®æ ‡.
        #è¯¥æ–¹æ³•ä¼šè¿”å›žä¸€ä¸ªåŒ…å«æ£€æµ‹åˆ°çš„äººè„¸ä½ç½®ä¿¡æ¯çš„åˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ç»„åæ ‡ä¿¡æ¯ð‘¥,ð‘¦,ð‘¤,â„Ž ã€‚xï¼Œyï¼Œwï¼Œhä»£è¡¨æ£€æµ‹åˆ°çš„äººè„¸çŸ©å½¢åŒºåŸŸçš„å·¦ä¸Šè§’åæ ‡xï¼Œyå’Œå®½åº¦wé«˜åº¦hã€‚
        #ä¾‹å¦‚ï¼Œå¦‚æžœæ£€æµ‹åˆ°ä¸€ä¸ªäººè„¸ï¼Œå¯èƒ½ä¼šè¿”å›žç±»ä¼¼(x 1ï¼Œy 1ï¼Œw 1ï¼Œh 1)çš„åˆ—è¡¨ï¼Œå¦‚æžœæ£€æµ‹åˆ°å¤šä¸ªäººè„¸ï¼Œå¯èƒ½ä¼šè¿”å›žç±»ä¼¼(x 1ï¼Œy 1ï¼Œw 1ï¼Œh 1ï¼‰ï¼Œï¼ˆx 2ï¼Œy 2ï¼Œw 2ï¼Œh 2ï¼‰ï¼Œ...çš„åˆ—è¡¨ã€‚
        faces = haar.detectMultiScale(gray_img, 1.3, 5)
        #å¾ªçŽ¯å¤„ç†æ¯ä¸€ä¸ªäººè„¸
        for f_x, f_y, f_w, f_h in faces:
            #æ ¹æ®è¯»å–çš„åˆ—è¡¨èŽ·å¾—æ¯ä¸€ä¸ªäººè„¸çš„ä½ç½®ï¼ŒéšåŽåªè¯»å–äººè„¸èŒƒå›´çš„ä½ç½®å¹¶é‡æ–°èµ‹å€¼ç»™face
            face = img[f_y:f_y+f_h, f_x:f_x+f_w]
            #è¿™æ˜¯å›¾åƒå¯è§†åŒ–çš„å¤§å°ä¹Ÿå°±æ˜¯ä½ èŽ·å–å›¾åƒæ—¶æ‘„åƒå¤´å±•ç¤ºå›¾ç‰‡çš„å¤§å°ï¼Œä¸ºä»€ä¹ˆè®¾ç½®è¿™ä¹ˆå°å‘¢ï¼Ÿ
            #å°†äººè„¸å°ºå¯¸è®¾ç½®ä¸º64,64çš„ä¸»è¦åŽŸå› æ˜¯ä¸ºäº†ä¸Žç¥žç»ç½‘ç»œçš„è¾“å…¥å°ºå¯¸ç›¸åŒ¹é…ã€‚åœ¨å¾ˆå¤šäººè„¸è¯†åˆ«å’Œäººè„¸ç›¸å…³ä»»åŠ¡çš„æ·±åº¦å­¦ä¹ æ¨¡åž‹ä¸­ï¼Œå¸¸å¸¸è¦æ±‚è¾“å…¥çš„å›¾åƒå°ºå¯¸æ˜¯å›ºå®šçš„ï¼Œé€šå¸¸æ˜¯ä¸ºäº†æ–¹ä¾¿æ¨¡åž‹è®­ç»ƒå’Œé™ä½Žè®¡ç®—å¤æ‚åº¦ã€‚
            #ç»Ÿä¸€å°ºå¯¸ï¼šä¿è¯æ‰€æœ‰äººè„¸å›¾åƒçš„å°ºå¯¸éƒ½æ˜¯ä¸€è‡´çš„ï¼Œè¿™æ ·å¯ä»¥ç®€åŒ–ç½‘ç»œç»“æž„ï¼Œé¿å…åœ¨è¾“å…¥æ—¶éœ€è¦è¿›è¡Œå°ºå¯¸å˜æ¢ã€‚
            #åŠ é€Ÿè®­ç»ƒï¼šç»Ÿä¸€çš„è¾“å…¥å°ºå¯¸æ„å‘³ç€åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­å¯ä»¥æ‰¹é‡å¤„ç†ç›¸åŒå°ºå¯¸çš„æ•°æ®ï¼Œä»Žè€ŒåŠ å¿«è®­ç»ƒé€Ÿåº¦ã€‚
            #é™ä½Žè®¡ç®—éœ€æ±‚ï¼šè¾ƒå°çš„è¾“å…¥å°ºå¯¸å¯ä»¥å‡å°‘æ¨¡åž‹éœ€è¦å¤„ç†çš„æ•°æ®é‡ï¼Œä»Žè€Œé™ä½Žè®¡ç®—éœ€æ±‚ï¼ŒåŠ é€Ÿæ¨¡åž‹æŽ¨ç†å’Œè®­ç»ƒè¿‡ç¨‹ã€‚
            face = cv2.resize(face, (64,64))
            '''
            if n % 3 == 1:
                face = relight(face, 1, 50)
            elif n % 3 == 2:
                face = relight(face, 0.5, 0)
            '''
            face = relight(face, random.uniform(0.5, 1.5), random.randint(-50, 50))
            cv2.imshow('img', face)
            cv2.imwrite(out_dir+'/'+str(n)+'.jpg', face)
            n+=1
        key = cv2.waitKey(30) & 0xff
        if key == 27:
            break
    else:
        break